<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç¦ä¿éšªç®¡å®¶ | æŠ•ä¿æ—…å¹³éšªAIå°ˆæ¡ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: {
                            50: '#f0fdfd',
                            100: '#ccfbfb',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                        },
                        brand: {
                            DEFAULT: '#4bbebe', // ä¸»è‰²èª¿
                            light: '#eaf8f8',
                            dark: '#2a8585',
                            text: '#2a8585'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Microsoft JhengHei', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Message Animation */
        @keyframes message-pop {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .msg-animate {
            animation: message-pop 0.3s ease-out forwards;
        }
        
        /* Loading Dots */
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 h-screen overflow-hidden flex flex-col max-w-2xl mx-auto shadow-2xl relative">

    <!-- Header -->
    <header class="bg-brand p-4 flex items-center justify-between text-white shrink-0 shadow-md z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/30">
                <span class="text-2xl">ğŸ•µï¸</span>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">é˜¿ç¦ä¿éšªç®¡å®¶</h1>
                <p class="text-xs text-white/90">æŠ•ä¿æ—…å¹³éšªAIå°ˆæ¡ˆ</p>
            </div>
        </div>
        <button onclick="restartApp()" class="p-2 hover:bg-white/10 rounded-full transition-colors text-white" title="é‡æ–°é–‹å§‹">
            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- Chat Area -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 scroll-smooth pb-20">
        <!-- Messages will be injected here -->
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t border-slate-200 p-3 shrink-0 pb-6 z-20 absolute bottom-0 w-full max-w-2xl">
        
        <!-- Dynamic Actions Container -->
        <div id="action-container" class="mb-3">
            <!-- Chips or DatePicker will be injected here -->
        </div>

        <!-- Text Input -->
        <div class="flex gap-2 items-center relative">
            <input type="text" id="user-input" 
                class="flex-1 bg-slate-100 border-none rounded-full px-4 py-3 focus:ring-2 focus:ring-brand focus:bg-white transition-all text-sm outline-none disabled:opacity-50 text-slate-700 placeholder:text-slate-400"
                placeholder="è«‹è¼¸å…¥è¨Šæ¯..." 
                onkeydown="if(event.key === 'Enter') handleInput()">
            
            <button onclick="handleInput()" id="send-btn"
                class="w-10 h-10 bg-brand hover:bg-brand-dark text-white rounded-full flex items-center justify-center transition-transform active:scale-95 disabled:bg-slate-300 disabled:cursor-not-allowed shadow-md">
                <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
            </button>
        </div>
        
        <div id="status-text" class="text-center mt-2 text-xs text-slate-400 hidden">
            AI ç¬¬ä¸€éšæ®µå ±åƒ¹å®Œæˆã€‚
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Data ---
        const SCHENGEN_COUNTRIES = [
            "å¥§åœ°åˆ©", "æ¯”åˆ©æ™‚", "æ·å…‹", "ä¸¹éº¥", "æ„›æ²™å°¼äº", "èŠ¬è˜­", "æ³•åœ‹", "å¾·åœ‹", "å¸Œè‡˜", "åŒˆç‰™åˆ©",
            "å†°å³¶", "ç¾©å¤§åˆ©", "æ‹‰è„«ç¶­äº", "åˆ—æ”¯æ•¦æ–¯ç™»", "ç«‹é™¶å®›", "ç›§æ£®å ¡", "é¦¬çˆ¾ä»–", "è·è˜­", "æŒªå¨",
            "æ³¢è˜­", "è‘¡è„ç‰™", "æ–¯æ´›ä¼å…‹", "æ–¯æ´›ç¶­å°¼äº", "è¥¿ç­ç‰™", "ç‘å…¸", "ç‘å£«", "å…‹ç¾…åŸƒè¥¿äº"
        ];

        const HOT_SPOTS = [
            { label: "ğŸ‡¹ğŸ‡¼ å°ç£åœ‹å…§", value: "domestic" },
            { label: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬", value: "overseas" },
            { label: "ğŸ‡°ğŸ‡· éŸ“åœ‹", value: "overseas" },
            { label: "ğŸ‡«ğŸ‡· æ³•åœ‹ (ç”³æ ¹)", value: "schengen" },
            { label: "ğŸ‡ºğŸ‡¸ ç¾åœ‹", value: "overseas" },
        ];

        const PREMIUM_DATA = {
            tfmi: {
                name: "å°ç£ç”¢ç‰©ä¿éšª",
                plans: [
                { 
                    type: "domestic", name: "åœ‹å…§æš¢éŠæ–¹æ¡ˆ", 
                    tags: ["æ„å¤–èº«æ•…", "å‚·å®³é†«ç™‚10%", "ç­æ©Ÿå»¶èª¤2åƒ"],
                    rates: [
                    { days: 1, sum: 2000000, prem: 80 }, { days: 2, sum: 2000000, prem: 105 }, { days: 3, sum: 2000000, prem: 135 },
                    { days: 4, sum: 2000000, prem: 160 }, { days: 5, sum: 2000000, prem: 185 }, { days: 10, sum: 2000000, prem: 310 },
                    { days: 1, sum: 5000000, prem: 150 }, { days: 2, sum: 5000000, prem: 210 }, { days: 5, sum: 5000000, prem: 375 }
                    ]
                },
                { 
                    type: "overseas", name: "åœ‹å¤–è¼•é¬†è¡Œ", 
                    tags: ["æµ·å¤–çªç™¼ç–¾ç—…", "ç­æ©Ÿå»¶èª¤4åƒ", "è¡Œæéºå¤±"],
                    rates: [
                    { days: 1, sum: 5000000, prem: 260 }, { days: 5, sum: 5000000, prem: 580 }, { days: 10, sum: 5000000, prem: 980 },
                    { days: 5, sum: 10000000, prem: 1100 }, { days: 7, sum: 10000000, prem: 1450 }, { days: 10, sum: 10000000, prem: 1900 },
                    { days: 30, sum: 10000000, prem: 4200 }
                    ]
                }
                ]
            },
            fubon: {
                name: "å¯Œé‚¦ç”¢éšª",
                plans: [
                { 
                    type: "overseas", name: "æµ·å¤–å¿«æ¨‚æ—…å¹³éšª", 
                    tags: ["å€‹äººè²¬ä»»éšª", "ç­æ©Ÿå»¶èª¤5åƒ", "æµ·å¤–çªç™¼ç–¾ç—…"],
                    rates: [
                    { days: 1, sum: 6000000, prem: 350 }, { days: 5, sum: 6000000, prem: 780 }, { days: 10, sum: 6000000, prem: 1250 },
                    { days: 5, sum: 12000000, prem: 1450 }, { days: 10, sum: 12000000, prem: 2300 }, { days: 30, sum: 12000000, prem: 5100 }
                    ]
                },
                { 
                    type: "schengen", name: "ç”³æ ¹ç°½è­‰å°ˆç”¨", 
                    tags: ["ç”³æ ¹é«˜é¡é†«ç™‚", "SOSæ€¥é›£æ•‘åŠ©", "ç¬¦åˆç°½è­‰è¦ç¯„"],
                    rates: [
                    { days: 7, sum: 6000000, prem: 1300 }, { days: 10, sum: 6000000, prem: 1680 }, { days: 15, sum: 6000000, prem: 2100 }
                    ]
                }
                ]
            },
            cathay: {
                name: "åœ‹æ³°ç”¢éšª",
                plans: [
                { 
                    type: "overseas", name: "æµ·å¤–éŠ - è±ªè¯å‹", 
                    tags: ["ç­æ©Ÿå»¶èª¤1è¬", "æ—…ç¨‹æ›´æ”¹", "é«˜é¡é†«ç™‚"],
                    rates: [
                    { days: 3, sum: 5000000, prem: 700 }, { days: 5, sum: 5000000, prem: 920 },
                    { days: 5, sum: 10000000, prem: 1650 }, { days: 10, sum: 10000000, prem: 2600 }
                    ]
                }
                ]
            },
            tokio: {
                name: "æ–°å®‰æ±äº¬",
                plans: [
                { 
                    type: "overseas", name: "å¹³å®‰ç¦æµ·å¤–", 
                    tags: ["é†«ç™‚å¯¦æ”¯å¯¦ä»˜", "ç­æ©Ÿå»¶èª¤", "è¡Œææå¤±"],
                    rates: [
                    { days: 1, sum: 6000000, prem: 320 }, { days: 5, sum: 6000000, prem: 680 },
                    { days: 5, sum: 10000000, prem: 1150 }
                    ]
                }
                ]
            },
            chubb: {
                name: "å®‰é”ç”¢éšª",
                plans: [
                { 
                    type: "schengen", name: "ç”³æ ¹æ­æ´²ç²¾é¸", 
                    tags: ["å…¨çƒæ”¯æ´", "ç”³æ ¹åˆè¦", "é«˜é¡çªç™¼ç–¾ç—…"],
                    rates: [
                    { days: 7, sum: 5000000, prem: 1100 }, { days: 10, sum: 10000000, prem: 2400 }
                    ]
                },
                { 
                    type: "overseas", name: "å…¨çƒæ—…éŠä¿éšœ", 
                    tags: ["å…¨çƒæ”¯æ´", "å‚·å®³é†«ç™‚", "ç­æ©Ÿå»¶èª¤"],
                    rates: [
                    { days: 1, sum: 5000000, prem: 280 }, { days: 5, sum: 5000000, prem: 620 }
                    ]
                }
                ]
            }
        };

        // --- Logic Helper Functions ---
        
        function interpolate(x, x1, y1, x2, y2) {
            if (x2 === x1) return y1;
            return y1 + (x - x1) * ((y2 - y1) / (x2 - x1));
        }

        function calculatePremium(companyId, plan, days, targetSum = 10000000) {
            const rates = plan.rates;
            let relevantRates = rates.filter(r => r.sum >= targetSum);
            if (relevantRates.length === 0) {
                const maxSum = Math.max(...rates.map(r => r.sum));
                relevantRates = rates.filter(r => r.sum === maxSum);
            } else {
                const minRelevantSum = Math.min(...relevantRates.map(r => r.sum));
                relevantRates = relevantRates.filter(r => r.sum === minRelevantSum);
            }
            
            relevantRates.sort((a, b) => a.days - b.days);

            const getPriceForDay = (d) => {
                if (d <= 0) return 0;
                const exact = relevantRates.find(r => r.days === d);
                if (exact) return exact.prem;

                const lower = relevantRates.filter(r => r.days < d).pop();
                const upper = relevantRates.find(r => r.days > d);

                if (lower && upper) {
                    return Math.round(interpolate(d, lower.days, lower.prem, upper.days, upper.prem));
                } else if (lower) {
                    return Math.round(lower.prem * (d / lower.days)); 
                } else if (upper) {
                    return Math.round(upper.prem * (d / upper.days));
                }
                return 0;
            };

            const centerPrice = getPriceForDay(days);
            const minPrice = getPriceForDay(days - 1);
            const maxPrice = getPriceForDay(days + 1);

            return {
                sumInsured: relevantRates[0]?.sum || 0,
                center: centerPrice,
                range: [
                    Math.min(minPrice > 0 ? minPrice : centerPrice, centerPrice), 
                    Math.max(maxPrice, centerPrice)
                ]
            };
        }

        function parseDateInput(input) {
            const dateRegex = /(\d{4})?[/-](\d{1,2})[/-](\d{1,2})/g;
            const datesFound = [...input.matchAll(dateRegex)];
            const now = new Date();

            if (datesFound.length >= 2) {
                const d1 = datesFound[0];
                const d2 = datesFound[1];
                const year1 = d1[1] ? parseInt(d1[1]) : now.getFullYear();
                const year2 = d2[1] ? parseInt(d2[1]) : now.getFullYear();
                const start = new Date(year1, parseInt(d1[2])-1, parseInt(d1[3]), 8, 0); 
                const end = new Date(year2, parseInt(d2[2])-1, parseInt(d2[3]), 8, 0);
                return { start, end };
            } 
            
            if (input.includes('å¤©')) {
                const daysMatch = input.match(/(\d+)å¤©/);
                if (daysMatch) {
                    const days = parseInt(daysMatch[1]);
                    const start = new Date();
                    start.setDate(start.getDate() + 1);
                    start.setHours(8, 0, 0, 0);
                    const end = new Date(start);
                    end.setDate(end.getDate() + (days - 1)); 
                    return { start, end };
                }
            }
            return null;
        }

        // --- State Management ---
        let currentStep = 'DESTINATION'; // DESTINATION, DATES, QUOTATION
        let tripData = { location: '', locationType: '', startTime: null, endTime: null, days: 0 };
        let datePickerValues = { startDate: '', startTime: '08:00', endDate: '', endTime: '08:00' };

        // --- UI Rendering ---

        function initApp() {
            lucide.createIcons();
            appendMessage('bot', 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯é˜¿ç¦ä¿éšªç®¡å®¶ï¼æˆ‘æ˜¯æ‚¨çš„ AI æŠ•ä¿åŠ©ç†ã€‚\n\nè«‹å•æ‚¨é€™æ¬¡æ—…è¡Œçš„ç›®çš„åœ°æ˜¯å“ªè£¡å‘¢ï¼Ÿ(ä¾‹å¦‚ï¼šæ—¥æœ¬ã€æ³•åœ‹ã€æˆ–åœ‹å…§æ—…éŠ)');
            renderActionArea();
        }

        function appendMessage(sender, text, type = 'text', data = null) {
            const container = document.getElementById('chat-container');
            const isUser = sender === 'user';
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} msg-animate`;

            const inner = document.createElement('div');
            inner.className = `flex gap-2 max-w-[85%] ${isUser ? 'flex-row-reverse' : ''}`;

            // Avatar
            const avatar = document.createElement('div');
            avatar.className = `w-9 h-9 rounded-full flex-shrink-0 flex items-center justify-center text-sm shadow-sm ${isUser ? 'bg-slate-200 text-slate-600' : 'bg-brand text-white border-2 border-white'}`;
            
            // Avatar Icon
            if (isUser) {
                avatar.innerHTML = `<i data-lucide="user" class="w-5 h-5"></i>`;
            } else {
                avatar.innerText = 'ğŸ•µï¸';
            }

            // Bubble
            const bubble = document.createElement('div');
            bubble.className = `rounded-2xl p-3.5 shadow-sm text-sm leading-relaxed whitespace-pre-wrap relative ${isUser ? 'bg-brand text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-100 rounded-tl-none'}`;
            
            if (type === 'loading') {
                bubble.innerHTML = `
                <div class="flex gap-1 items-center h-5 px-2">
                    <span class="w-1.5 h-1.5 bg-brand rounded-full loading-dot"></span>
                    <span class="w-1.5 h-1.5 bg-brand rounded-full loading-dot"></span>
                    <span class="w-1.5 h-1.5 bg-brand rounded-full loading-dot"></span>
                </div>`;
            } else {
                bubble.innerText = text;
            }

            inner.appendChild(avatar);
            inner.appendChild(bubble);
            wrapper.appendChild(inner);
            container.appendChild(wrapper);

            // Cards specific logic (Separate wrapper)
            if (type === 'quote_cards' && data) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = "w-full my-4 animate-in fade-in slide-in-from-bottom-4 duration-500";
                
                let cardsHtml = `<div class="flex overflow-x-auto pb-6 pt-2 px-2 snap-x space-x-3 scrollbar-hide -mx-4 md:mx-0 pl-6 md:pl-2">`;
                data.forEach(quote => {
                    cardsHtml += renderCardHtml(quote);
                });
                cardsHtml += `</div>`;
                
                cardWrapper.innerHTML = cardsHtml;
                container.appendChild(cardWrapper);
            }

            container.scrollTop = container.scrollHeight;
            lucide.createIcons();

            return wrapper; // Return wrapper to remove if loading
        }

        function renderCardHtml(quote) {
             // Determine Badge Style
            let badgeStyle = "bg-brand-light text-brand-dark border-brand-light";
            let badgeIcon = "";

            if (quote.badgeType === 'recommend') { // Cathay
                badgeStyle = "bg-orange-100 text-orange-700 border-orange-200 font-bold";
                badgeIcon = `<i data-lucide="star" class="w-3 h-3 text-orange-500 mr-1 fill-orange-500"></i>`;
            } else if (quote.badgeType === 'sufficient') { // Fubon
                badgeStyle = "bg-blue-100 text-blue-700 border-blue-200 font-bold";
                badgeIcon = `<i data-lucide="shield" class="w-3 h-3 text-blue-600 mr-1"></i>`;
            } else if (quote.badgeType === 'economic') { // Chubb
                badgeStyle = "bg-emerald-100 text-emerald-700 border-emerald-200 font-bold";
                badgeIcon = `<i data-lucide="trending-down" class="w-3 h-3 text-emerald-600 mr-1"></i>`;
            }

            const tagsHtml = quote.tags.slice(0, 3).map(tag => 
                `<span class="text-[11px] bg-brand-light text-brand-dark px-2 py-1 rounded-md border border-brand/20">${tag}</span>`
            ).join('');

            return `
            <div class="min-w-[280px] md:min-w-[320px] bg-white rounded-xl shadow-lg border border-brand/20 p-5 flex flex-col snap-center mx-2 h-full relative overflow-hidden">
                ${quote.badge ? `
                <div class="absolute top-0 right-0 px-3 py-1.5 text-xs rounded-bl-xl border-l border-b flex items-center shadow-sm ${badgeStyle}">
                    ${badgeIcon}
                    ${quote.badge}
                </div>` : ''}

                <div class="flex justify-between items-start mb-4 mt-2">
                    <div class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">
                    ${quote.companyName}
                    </div>
                </div>
                
                <h3 class="text-xl font-bold text-slate-800 mb-2 leading-tight">${quote.planName}</h3>
                <div class="text-sm text-slate-500 mb-4 pb-4 border-b border-slate-100">
                    æ„å¤–èº«æ•…ä¿é¡: <span class="font-medium text-slate-800 text-lg ml-1">${(quote.sumInsured / 10000).toLocaleString()} è¬</span>
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    ${tagsHtml}
                </div>
                
                <div class="mt-auto">
                    <div class="flex flex-col mb-3">
                        <span class="text-xs text-slate-400 mb-1">é ä¼°ä¿è²»ç¯„åœ</span>
                        <div class="text-2xl font-bold text-brand">
                            $${quote.range[0].toLocaleString()} ~ $${quote.range[1].toLocaleString()}
                        </div>
                    </div>
                    <button class="w-full bg-brand hover:bg-brand-dark text-white py-3 rounded-lg text-sm font-bold transition-colors shadow-sm flex items-center justify-center gap-2">
                    é¸æ“‡æ­¤æ–¹æ¡ˆ <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderActionArea() {
            const container = document.getElementById('action-container');
            const input = document.getElementById('user-input');
            const statusText = document.getElementById('status-text');
            container.innerHTML = '';

            input.disabled = false;
            statusText.classList.add('hidden');
            input.placeholder = "è«‹è¼¸å…¥è¨Šæ¯...";

            if (currentStep === 'DESTINATION') {
                input.placeholder = "è¼¸å…¥åœ‹å®¶æˆ–åŸå¸‚...";
                const wrapper = document.createElement('div');
                wrapper.className = "flex gap-2 overflow-x-auto pb-1 scrollbar-hide";
                
                HOT_SPOTS.forEach(spot => {
                    const btn = document.createElement('button');
                    btn.className = "whitespace-nowrap px-4 py-2 bg-brand-light text-brand-dark rounded-full text-xs font-medium border border-brand/20 hover:bg-brand/10 transition-colors shadow-sm";
                    btn.innerText = spot.label;
                    btn.onclick = () => handleQuickReply(spot.value, spot.label);
                    wrapper.appendChild(btn);
                });
                container.appendChild(wrapper);

            } else if (currentStep === 'DATES') {
                input.placeholder = "æ‰‹å‹•è¼¸å…¥ (ä¾‹ï¼šä¸‹é€±äº”å»æ—¥æœ¬äº”å¤©) æˆ–ç”¨ä¸Šæ–¹é¸æ“‡å™¨";
                
                // Initialize default date (tomorrow)
                if(!datePickerValues.startDate) {
                    const tmr = new Date();
                    tmr.setDate(tmr.getDate() + 1);
                    const dateStr = tmr.toISOString().split('T')[0];
                    datePickerValues.startDate = dateStr;
                    datePickerValues.endDate = dateStr;
                }

                const wrapper = document.createElement('div');
                wrapper.className = "p-3 bg-brand-light rounded-xl border border-brand/20 shadow-inner";
                wrapper.innerHTML = `
                    <div class="flex items-center gap-2 mb-2 text-xs font-bold text-brand-dark">
                        <i data-lucide="calendar" class="w-3 h-3"></i> æ—¥æœŸé¸æ“‡å™¨ (æˆ–æ–¼ä¸‹æ–¹ç›´æ¥è¼¸å…¥)
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] text-slate-500 font-medium ml-1">å‡ºç™¼æ™‚é–“</label>
                            <div class="flex gap-1">
                                <input type="date" id="picker-start-date" value="${datePickerValues.startDate}" class="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-brand outline-none" onchange="updatePickerValue('startDate', this.value)">
                                <input type="time" id="picker-start-time" value="${datePickerValues.startTime}" class="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-brand outline-none" onchange="updatePickerValue('startTime', this.value)">
                            </div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] text-slate-500 font-medium ml-1">è¿”å›æ™‚é–“</label>
                            <div class="flex gap-1">
                                <input type="date" id="picker-end-date" value="${datePickerValues.endDate}" class="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-brand outline-none" onchange="updatePickerValue('endDate', this.value)">
                                <input type="time" id="picker-end-time" value="${datePickerValues.endTime}" class="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-brand outline-none" onchange="updatePickerValue('endTime', this.value)">
                            </div>
                        </div>
                    </div>
                    <button onclick="submitDatesFromPicker()" class="w-full py-2 bg-brand hover:bg-brand-dark text-white rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1 shadow-sm">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> ä½¿ç”¨é¸æ“‡å™¨çš„æ—¥æœŸ
                    </button>
                `;
                container.appendChild(wrapper);

            } else if (currentStep === 'QUOTATION') {
                input.placeholder = "å ±åƒ¹å®Œæˆï¼Œè«‹é‡æ–°é–‹å§‹...";
                input.disabled = true;
                statusText.classList.remove('hidden');
            }
            
            lucide.createIcons();
        }

        // --- Interaction Handlers ---

        function handleInput() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            appendMessage('user', text);

            // Simulate AI Delay
            setTimeout(() => {
                const irrelevantKeywords = ['å¤©æ°£', 'è‚¡ç¥¨', 'ç¬‘è©±', 'åƒé£¯', 'èŠå¤©'];
                if (irrelevantKeywords.some(kw => text.includes(kw))) {
                    appendMessage('bot', 'é˜¿ç¦ç›®å‰å°ˆæ³¨æ–¼å”åŠ©æ‚¨æŠ•ä¿ï¼Œæˆ‘å€‘å¯ä»¥å…ˆå®ŒæˆæŠ•ä¿æµç¨‹å†ä¾†èŠèŠå…¶ä»–è©±é¡Œå–”ï¼');
                    return;
                }

                if (currentStep === 'DESTINATION') {
                    processDestination(text);
                } else if (currentStep === 'DATES') {
                    processDateInput(text);
                }
            }, 600);
        }

        function handleQuickReply(val, label) {
            appendMessage('user', label);
            if (currentStep === 'DESTINATION') {
                setTimeout(() => processDestination(label), 500);
            }
        }

        function updatePickerValue(key, value) {
            datePickerValues[key] = value;
        }

        function processDestination(input) {
            let type = 'overseas';
            let cleanInput = input.trim();

            if (cleanInput.includes('åœ‹å…§') || cleanInput.includes('å°ç£') || cleanInput.includes('å°æ±') || cleanInput.includes('å°åŒ—')) {
                type = 'domestic';
            } else if (SCHENGEN_COUNTRIES.some(c => cleanInput.includes(c)) || cleanInput.includes('ç”³æ ¹') || cleanInput.includes('æ­æ´²')) {
                type = 'schengen';
            }

            tripData.location = cleanInput;
            tripData.locationType = type;
            currentStep = 'DATES';

            appendMessage('bot', `æ”¶åˆ°ï¼Œæ‚¨çš„ç›®çš„åœ°æ˜¯ **${cleanInput}** (${type === 'schengen' ? 'ç”³æ ¹åœ°å€' : type === 'domestic' ? 'åœ‹å…§æ—…éŠ' : 'æµ·å¤–æ—…éŠ'})ã€‚`);
            setTimeout(() => {
                appendMessage('bot', `è«‹å‘ŠçŸ¥æ‚¨çš„ **å‡ºç™¼** èˆ‡ **è¿”å›** æ™‚é–“ã€‚\n\næ‚¨å¯ä»¥ç›´æ¥è¼¸å…¥(å¦‚ï¼šä¸‹é€±äº”å»äº”å¤©)ï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹çš„æ—¥æœŸé¸æ“‡å™¨ã€‚`);
                renderActionArea();
            }, 500);
        }

        function submitDatesFromPicker() {
            const { startDate, startTime, endDate, endTime } = datePickerValues;
            if (!startDate || !startTime || !endDate || !endTime) return;

            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            
            appendMessage('user', `æˆ‘è¦å¾ ${startDate} ${startTime} å‡ºç™¼ï¼Œåˆ° ${endDate} ${endTime} è¿”å›`);
            validateAndProcessDates(start, end);
        }

        function processDateInput(input) {
            const result = parseDateInput(input);
            if (result) {
                validateAndProcessDates(result.start, result.end);
            } else {
                appendMessage('bot', 'ä¸å¥½æ„æ€ï¼Œæˆ‘ä¸å¤ªç¢ºå®šæ‚¨è¼¸å…¥çš„æ—¥æœŸã€‚è«‹å†æ¬¡ç¢ºèªæ ¼å¼ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ä¸Šæ–¹çš„æ—¥æœŸé¸æ“‡å™¨æŒ‰éˆ•æäº¤å–”ï¼');
            }
        }

        function validateAndProcessDates(start, end) {
            const now = new Date();
            const minTime = new Date(now.getTime() + 4 * 60 * 60 * 1000); // 4 hours from now

            if (start < minTime) {
                appendMessage('bot', 'âš ï¸ æŠ•ä¿ç”Ÿæ•ˆæ™‚é–“å¿…é ˆè·é›¢ç¾åœ¨è‡³å°‘ 4 å°æ™‚ä¹‹å¾Œå–”ï¼è«‹èª¿æ•´æ‚¨çš„å‡ºç™¼æ™‚é–“ã€‚');
                return;
            }
            if (end <= start) {
                appendMessage('bot', 'âš ï¸ è¿”å›æ™‚é–“å¿…é ˆæ™šæ–¼å‡ºç™¼æ™‚é–“å–”ï¼');
                return;
            }

            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const finalDays = diffDays === 0 ? 1 : diffDays;

            tripData.startTime = start;
            tripData.endTime = end;
            tripData.days = finalDays;

            currentStep = 'QUOTATION';
            renderActionArea();

            const fmtStart = start.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const fmtEnd = end.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});

            appendMessage('bot', `å¥½çš„ï¼ç‚ºæ‚¨ç¢ºèªè¡Œç¨‹ï¼š\nğŸ“… **${fmtStart}** è‡³ **${fmtEnd}**\nå…±è¨ˆ **${finalDays}** å¤©ã€‚`);
            
            const loadingMsg = appendMessage('bot', '', 'loading');

            setTimeout(() => {
                loadingMsg.remove();
                generateQuotes(tripData.locationType, finalDays);
            }, 1500);
        }

        function generateQuotes(locType, days) {
            const results = [];
            
            Object.keys(PREMIUM_DATA).forEach(key => {
                const company = PREMIUM_DATA[key];
                const validPlans = company.plans.filter(p => {
                    if (locType === 'domestic') return p.type === 'domestic';
                    if (locType === 'schengen') return p.type === 'schengen' || p.type === 'overseas';
                    return p.type === 'overseas';
                });

                validPlans.forEach(plan => {
                    const quote = calculatePremium(key, plan, days);
                    if (quote.center > 0) {
                        let badge = null;
                        let badgeType = 'default';

                        if (key === 'cathay') {
                            badge = 'é˜¿ç¦æ¨è–¦';
                            badgeType = 'recommend';
                        } else if (key === 'fubon') {
                            badge = 'ä¿éšœå……è¶³';
                            badgeType = 'sufficient';
                        } else if (key === 'chubb') {
                            badge = 'ç¶“æ¿Ÿå¯¦æƒ ';
                            badgeType = 'economic';
                        }

                        results.push({
                            companyId: key,
                            companyName: company.name,
                            planName: plan.name,
                            sumInsured: quote.sumInsured,
                            price: quote.center,
                            range: quote.range,
                            tags: plan.tags || [],
                            badge,
                            badgeType
                        });
                    }
                });
            });

            // Sort by Range MAX Value Descending
            results.sort((a, b) => b.range[1] - a.range[1]);

            const responseText = `ç‚ºæ‚¨æ‰¾åˆ°ä»¥ä¸‹äº”å®¶ä¿éšªå…¬å¸çš„æ–¹æ¡ˆã€‚
å„å®¶ä¿éšªå…¬å¸éƒ½æœ‰äº›å¾®çš„å·®ç•°èˆ‡ä¿éšœé¡åº¦çš„ä¸åŒã€‚
ä½†å”¯ä¸€ç›¸åŒçš„éƒ½æ˜¯æä¾›æ„å¤–èº«æ•…è‡³å°‘ä¿éšœ1000è¬ï¼Œä»¥åŠ100è¬çš„æµ·å¤–ç·Šæ€¥é†«ç™‚ï¼Œå“ªä¸€å€‹ä¿éšœæ–¹æ¡ˆå…§å®¹æˆ–ä¿è²»ç¬¦åˆæ‚¨çš„æœŸæœ›å‘¢?
é‚„æ˜¯æ‚¨æœ‰å…¶ä»–æ›´å¤šå•é¡Œæƒ³äº†è§£?`;

            appendMessage('bot', responseText);
            
            setTimeout(() => {
                appendMessage('bot', '', 'quote_cards', results);
            }, 400);
        }

        function restartApp() {
            currentStep = 'DESTINATION';
            tripData = { location: '', locationType: '', startTime: null, endTime: null, days: 0 };
            document.getElementById('chat-container').innerHTML = '';
            initApp();
        }

        // Initialize
        window.onload = initApp;

    </script>
</body>
</html>
