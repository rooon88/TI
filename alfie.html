import React, { useState, useEffect, useRef } from 'react';
import { Send, MapPin, Calendar, Plane, Shield, ChevronRight, RefreshCw, X, Clock, User, CheckCircle, ThumbsUp, Star, TrendingDown } from 'lucide-react';

// --- Mock Data ---

const SCHENGEN_COUNTRIES = [
  "å¥§åœ°åˆ©", "æ¯”åˆ©æ™‚", "æ·å…‹", "ä¸¹éº¥", "æ„›æ²™å°¼äº", "èŠ¬è˜­", "æ³•åœ‹", "å¾·åœ‹", "å¸Œè‡˜", "åŒˆç‰™åˆ©",
  "å†°å³¶", "ç¾©å¤§åˆ©", "æ‹‰è„«ç¶­äº", "åˆ—æ”¯æ•¦æ–¯ç™»", "ç«‹é™¶å®›", "ç›§æ£®å ¡", "é¦¬çˆ¾ä»–", "è·è˜­", "æŒªå¨",
  "æ³¢è˜­", "è‘¡è„ç‰™", "æ–¯æ´›ä¼å…‹", "æ–¯æ´›ç¶­å°¼äº", "è¥¿ç­ç‰™", "ç‘å…¸", "ç‘å£«", "å…‹ç¾…åŸƒè¥¿äº"
];

const HOT_SPOTS = [
  { label: "ğŸ‡¹ğŸ‡¼ å°ç£åœ‹å…§", value: "domestic" },
  { label: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬", value: "overseas" },
  { label: "ğŸ‡°ğŸ‡· éŸ“åœ‹", value: "overseas" },
  { label: "ğŸ‡«ğŸ‡· æ³•åœ‹ (ç”³æ ¹)", value: "schengen" },
  { label: "ğŸ‡ºğŸ‡¸ ç¾åœ‹", value: "overseas" },
];

const PREMIUM_DATA = {
  tfmi: {
    name: "å°ç£ç”¢ç‰©ä¿éšª",
    plans: [
      { 
        type: "domestic", name: "åœ‹å…§æš¢éŠæ–¹æ¡ˆ", 
        tags: ["æ„å¤–èº«æ•…", "å‚·å®³é†«ç™‚10%", "ç­æ©Ÿå»¶èª¤2åƒ"],
        rates: [
          { days: 1, sum: 2000000, prem: 80 }, { days: 2, sum: 2000000, prem: 105 }, { days: 3, sum: 2000000, prem: 135 },
          { days: 4, sum: 2000000, prem: 160 }, { days: 5, sum: 2000000, prem: 185 }, { days: 10, sum: 2000000, prem: 310 },
          { days: 1, sum: 5000000, prem: 150 }, { days: 2, sum: 5000000, prem: 210 }, { days: 5, sum: 5000000, prem: 375 }
        ]
      },
      { 
        type: "overseas", name: "åœ‹å¤–è¼•é¬†è¡Œ", 
        tags: ["æµ·å¤–çªç™¼ç–¾ç—…", "ç­æ©Ÿå»¶èª¤4åƒ", "è¡Œæéºå¤±"],
        rates: [
          { days: 1, sum: 5000000, prem: 260 }, { days: 5, sum: 5000000, prem: 580 }, { days: 10, sum: 5000000, prem: 980 },
          { days: 5, sum: 10000000, prem: 1100 }, { days: 7, sum: 10000000, prem: 1450 }, { days: 10, sum: 10000000, prem: 1900 },
          { days: 30, sum: 10000000, prem: 4200 }
        ]
      }
    ]
  },
  fubon: {
    name: "å¯Œé‚¦ç”¢éšª",
    plans: [
      { 
        type: "overseas", name: "æµ·å¤–å¿«æ¨‚æ—…å¹³éšª", 
        tags: ["å€‹äººè²¬ä»»éšª", "ç­æ©Ÿå»¶èª¤5åƒ", "æµ·å¤–çªç™¼ç–¾ç—…"],
        rates: [
          { days: 1, sum: 6000000, prem: 350 }, { days: 5, sum: 6000000, prem: 780 }, { days: 10, sum: 6000000, prem: 1250 },
          { days: 5, sum: 12000000, prem: 1450 }, { days: 10, sum: 12000000, prem: 2300 }, { days: 30, sum: 12000000, prem: 5100 }
        ]
      },
      { 
        type: "schengen", name: "ç”³æ ¹ç°½è­‰å°ˆç”¨", 
        tags: ["ç”³æ ¹é«˜é¡é†«ç™‚", "SOSæ€¥é›£æ•‘åŠ©", "ç¬¦åˆç°½è­‰è¦ç¯„"],
        rates: [
          { days: 7, sum: 6000000, prem: 1300 }, { days: 10, sum: 6000000, prem: 1680 }, { days: 15, sum: 6000000, prem: 2100 }
        ]
      }
    ]
  },
  cathay: {
    name: "åœ‹æ³°ç”¢éšª",
    plans: [
      { 
        type: "overseas", name: "æµ·å¤–éŠ - è±ªè¯å‹", 
        tags: ["ç­æ©Ÿå»¶èª¤1è¬", "æ—…ç¨‹æ›´æ”¹", "é«˜é¡é†«ç™‚"],
        rates: [
          { days: 3, sum: 5000000, prem: 700 }, { days: 5, sum: 5000000, prem: 920 },
          { days: 5, sum: 10000000, prem: 1650 }, { days: 10, sum: 10000000, prem: 2600 }
        ]
      }
    ]
  },
  tokio: {
    name: "æ–°å®‰æ±äº¬",
    plans: [
      { 
        type: "overseas", name: "å¹³å®‰ç¦æµ·å¤–", 
        tags: ["é†«ç™‚å¯¦æ”¯å¯¦ä»˜", "ç­æ©Ÿå»¶èª¤", "è¡Œææå¤±"],
        rates: [
          { days: 1, sum: 6000000, prem: 320 }, { days: 5, sum: 6000000, prem: 680 },
          { days: 5, sum: 10000000, prem: 1150 }
        ]
      }
    ]
  },
  chubb: {
    name: "å®‰é”ç”¢éšª",
    plans: [
      { 
        type: "schengen", name: "ç”³æ ¹æ­æ´²ç²¾é¸", 
        tags: ["å…¨çƒæ”¯æ´", "ç”³æ ¹åˆè¦", "é«˜é¡çªç™¼ç–¾ç—…"],
        rates: [
           { days: 7, sum: 5000000, prem: 1100 }, { days: 10, sum: 10000000, prem: 2400 }
        ]
      },
      { 
        type: "overseas", name: "å…¨çƒæ—…éŠä¿éšœ", 
        tags: ["å…¨çƒæ”¯æ´", "å‚·å®³é†«ç™‚", "ç­æ©Ÿå»¶èª¤"],
        rates: [
          { days: 1, sum: 5000000, prem: 280 }, { days: 5, sum: 5000000, prem: 620 }
        ]
      }
    ]
  }
};

// --- Helper Functions ---

const interpolate = (x, x1, y1, x2, y2) => {
  if (x2 === x1) return y1;
  return y1 + (x - x1) * ((y2 - y1) / (x2 - x1));
};

const calculatePremium = (companyId, plan, days, targetSum = 10000000) => {
  const rates = plan.rates;
  let relevantRates = rates.filter(r => r.sum >= targetSum);
  if (relevantRates.length === 0) {
    const maxSum = Math.max(...rates.map(r => r.sum));
    relevantRates = rates.filter(r => r.sum === maxSum);
  } else {
    const minRelevantSum = Math.min(...relevantRates.map(r => r.sum));
    relevantRates = relevantRates.filter(r => r.sum === minRelevantSum);
  }
  
  relevantRates.sort((a, b) => a.days - b.days);

  const getPriceForDay = (d) => {
    if (d <= 0) return 0;
    const exact = relevantRates.find(r => r.days === d);
    if (exact) return exact.prem;

    const lower = relevantRates.filter(r => r.days < d).pop();
    const upper = relevantRates.find(r => r.days > d);

    if (lower && upper) {
      return Math.round(interpolate(d, lower.days, lower.prem, upper.days, upper.prem));
    } else if (lower) {
      return Math.round(lower.prem * (d / lower.days)); 
    } else if (upper) {
      return Math.round(upper.prem * (d / upper.days));
    }
    return 0;
  };

  const centerPrice = getPriceForDay(days);
  const minPrice = getPriceForDay(days - 1);
  const maxPrice = getPriceForDay(days + 1);

  return {
    sumInsured: relevantRates[0]?.sum || 0,
    center: centerPrice,
    range: [
      Math.min(minPrice > 0 ? minPrice : centerPrice, centerPrice), 
      Math.max(maxPrice, centerPrice)
    ]
  };
};

const generateId = () => Date.now().toString() + Math.random().toString(36).substr(2, 9);

const App = () => {
  // --- State ---
  const [messages, setMessages] = useState([
    { 
      id: generateId(), 
      sender: 'bot', 
      text: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯é˜¿ç¦ä¿éšªç®¡å®¶ï¼æˆ‘æ˜¯æ‚¨çš„ AI æŠ•ä¿åŠ©ç†ã€‚\n\nè«‹å•æ‚¨é€™æ¬¡æ—…è¡Œçš„ç›®çš„åœ°æ˜¯å“ªè£¡å‘¢ï¼Ÿ(ä¾‹å¦‚ï¼šæ—¥æœ¬ã€æ³•åœ‹ã€æˆ–åœ‹å…§æ—…éŠ)' 
    }
  ]);
  const [inputText, setInputText] = useState('');
  const [step, setStep] = useState('DESTINATION'); // DESTINATION, DATES, CONFIRM, QUOTATION
  const [tripData, setTripData] = useState({
    location: '',
    locationType: '', 
    startTime: null,
    endTime: null,
    days: 0
  });
  const [quotes, setQuotes] = useState([]);
  
  const [datePickerValues, setDatePickerValues] = useState({
    startDate: '',
    startTime: '08:00',
    endDate: '',
    endTime: '08:00'
  });

  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };
  useEffect(scrollToBottom, [messages]);

  // --- Logic Handlers ---

  const addMessage = (sender, text, type = 'text', data = null) => {
    setMessages(prev => [...prev, { id: generateId(), sender, text, type, data }]);
  };

  const handleDestination = (input) => {
    let type = 'overseas';
    let cleanInput = input.trim();

    if (cleanInput.includes('åœ‹å…§') || cleanInput.includes('å°ç£') || cleanInput.includes('å°æ±') || cleanInput.includes('å°åŒ—')) {
      type = 'domestic';
    } else if (SCHENGEN_COUNTRIES.some(c => cleanInput.includes(c)) || cleanInput.includes('ç”³æ ¹') || cleanInput.includes('æ­æ´²')) {
      type = 'schengen';
    }

    setTripData(prev => ({ ...prev, location: cleanInput, locationType: type }));
    setStep('DATES');
    
    const tmr = new Date();
    tmr.setDate(tmr.getDate() + 1);
    const dateStr = tmr.toISOString().split('T')[0];
    setDatePickerValues(prev => ({ ...prev, startDate: dateStr, endDate: dateStr }));

    setTimeout(() => {
      addMessage('bot', `æ”¶åˆ°ï¼Œæ‚¨çš„ç›®çš„åœ°æ˜¯ **${cleanInput}** (${type === 'schengen' ? 'ç”³æ ¹åœ°å€' : type === 'domestic' ? 'åœ‹å…§æ—…éŠ' : 'æµ·å¤–æ—…éŠ'})ã€‚`);
      addMessage('bot', `è«‹å‘ŠçŸ¥æ‚¨çš„ **å‡ºç™¼** èˆ‡ **è¿”å›** æ™‚é–“ã€‚\n\næ‚¨å¯ä»¥ç›´æ¥è¼¸å…¥(å¦‚ï¼šä¸‹é€±äº”å»äº”å¤©)ï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹çš„æ—¥æœŸé¸æ“‡å™¨ã€‚`);
    }, 500);
  };

  const parseDateInput = (input) => {
    const dateRegex = /(\d{4})?[/-](\d{1,2})[/-](\d{1,2})/g;
    const datesFound = [...input.matchAll(dateRegex)];
    const now = new Date();

    if (datesFound.length >= 2) {
       const d1 = datesFound[0];
       const d2 = datesFound[1];
       const year1 = d1[1] ? parseInt(d1[1]) : now.getFullYear();
       const year2 = d2[1] ? parseInt(d2[1]) : now.getFullYear();
       const start = new Date(year1, parseInt(d1[2])-1, parseInt(d1[3]), 8, 0); 
       const end = new Date(year2, parseInt(d2[2])-1, parseInt(d2[3]), 8, 0);
       return { start, end };
    } 
    
    if (input.includes('å¤©')) {
        const daysMatch = input.match(/(\d+)å¤©/);
        if (daysMatch) {
            const days = parseInt(daysMatch[1]);
            const start = new Date();
            start.setDate(start.getDate() + 1);
            start.setHours(8, 0, 0, 0);
            const end = new Date(start);
            end.setDate(end.getDate() + (days - 1)); 
            return { start, end };
        }
    }
    return null;
  };

  const handleDateInput = (input) => {
      const result = parseDateInput(input);
      if (result) {
          processDates(result.start, result.end);
      } else {
          addMessage('bot', 'ä¸å¥½æ„æ€ï¼Œæˆ‘ä¸å¤ªç¢ºå®šæ‚¨è¼¸å…¥çš„æ—¥æœŸã€‚è«‹å†æ¬¡ç¢ºèªæ ¼å¼ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ä¸Šæ–¹çš„æ—¥æœŸé¸æ“‡å™¨æŒ‰éˆ•æäº¤å–”ï¼');
      }
  };

  const processDates = (start, end) => {
    const now = new Date();
    const minTime = new Date(now.getTime() + 4 * 60 * 60 * 1000);
    if (start < minTime) {
        addMessage('bot', 'âš ï¸ æŠ•ä¿ç”Ÿæ•ˆæ™‚é–“å¿…é ˆè·é›¢ç¾åœ¨è‡³å°‘ 4 å°æ™‚ä¹‹å¾Œå–”ï¼è«‹èª¿æ•´æ‚¨çš„å‡ºç™¼æ™‚é–“ã€‚');
        return;
    }
    if (end <= start) {
        addMessage('bot', 'âš ï¸ è¿”å›æ™‚é–“å¿…é ˆæ™šæ–¼å‡ºç™¼æ™‚é–“å–”ï¼');
        return;
    }

    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const finalDays = diffDays === 0 ? 1 : diffDays;

    setTripData(prev => ({ 
      ...prev, 
      startTime: start, 
      endTime: end, 
      days: finalDays 
    }));
    
    setStep('QUOTATION');

    setTimeout(() => {
        const fmtStart = start.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
        const fmtEnd = end.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
        
        addMessage('bot', `å¥½çš„ï¼ç‚ºæ‚¨ç¢ºèªè¡Œç¨‹ï¼š\nğŸ“… **${fmtStart}** è‡³ **${fmtEnd}**\nå…±è¨ˆ **${finalDays}** å¤©ã€‚`);
        addMessage('bot', 'æ­£åœ¨ç‚ºæ‚¨è¨ˆç®—æœ€ä½³æ–¹æ¡ˆèˆ‡æ¯”åƒ¹...', 'loading');
        
        setTimeout(() => {
            generateQuotes(tripData.locationType, finalDays);
        }, 1500);
    }, 500);
  };

  const submitDatesFromPicker = () => {
    const { startDate, startTime, endDate, endTime } = datePickerValues;
    if (!startDate || !startTime || !endDate || !endTime) return;

    const start = new Date(`${startDate}T${startTime}`);
    const end = new Date(`${endDate}T${endTime}`);
    
    addMessage('user', `æˆ‘è¦å¾ ${startDate} ${startTime} å‡ºç™¼ï¼Œåˆ° ${endDate} ${endTime} è¿”å›`);
    processDates(start, end);
  };

  const generateQuotes = (locType, days) => {
    const results = [];
    
    Object.keys(PREMIUM_DATA).forEach(key => {
      const company = PREMIUM_DATA[key];
      const validPlans = company.plans.filter(p => {
        if (locType === 'domestic') return p.type === 'domestic';
        if (locType === 'schengen') return p.type === 'schengen' || p.type === 'overseas';
        return p.type === 'overseas';
      });

      validPlans.forEach(plan => {
        const quote = calculatePremium(key, plan, days);
        if (quote.center > 0) {
          // Custom Badge Logic
          let badge = null;
          let badgeType = 'default';

          if (key === 'cathay') {
            badge = 'é˜¿ç¦æ¨è–¦';
            badgeType = 'recommend';
          } else if (key === 'fubon') {
            badge = 'ä¿éšœå……è¶³';
            badgeType = 'sufficient';
          } else if (key === 'chubb') {
            badge = 'ç¶“æ¿Ÿå¯¦æƒ ';
            badgeType = 'economic';
          }

          results.push({
            companyId: key,
            companyName: company.name,
            planName: plan.name,
            sumInsured: quote.sumInsured,
            price: quote.center,
            range: quote.range,
            tags: plan.tags || [],
            badge,
            badgeType
          });
        }
      });
    });

    results.sort((a, b) => b.range[1] - a.range[1]);

    setMessages(prev => prev.filter(m => m.type !== 'loading'));
    setQuotes(results);
    
    const responseText = `ç‚ºæ‚¨æ‰¾åˆ°ä»¥ä¸‹äº”å®¶ä¿éšªå…¬å¸çš„æ–¹æ¡ˆã€‚
å„å®¶ä¿éšªå…¬å¸éƒ½æœ‰äº›å¾®çš„å·®ç•°èˆ‡ä¿éšœé¡åº¦çš„ä¸åŒã€‚
ä½†å”¯ä¸€ç›¸åŒçš„éƒ½æ˜¯æä¾›æ„å¤–èº«æ•…è‡³å°‘ä¿éšœ1000è¬ï¼Œä»¥åŠ100è¬çš„æµ·å¤–ç·Šæ€¥é†«ç™‚ï¼Œå“ªä¸€å€‹ä¿éšœæ–¹æ¡ˆå…§å®¹æˆ–ä¿è²»ç¬¦åˆæ‚¨çš„æœŸæœ›å‘¢?
é‚„æ˜¯æ‚¨æœ‰å…¶ä»–æ›´å¤šå•é¡Œæƒ³äº†è§£?`;

    // 1. Send Text Message first
    addMessage('bot', responseText);

    // 2. Send Cards Message separately (slightly delayed for effect)
    setTimeout(() => {
        addMessage('bot', '', 'quote_cards', results);
    }, 400);
  };

  const handleInput = () => {
    if (!inputText.trim()) return;
    const text = inputText;
    setInputText('');
    addMessage('user', text);

    setTimeout(() => {
      const irrelevantKeywords = ['å¤©æ°£', 'è‚¡ç¥¨', 'ç¬‘è©±', 'åƒé£¯', 'èŠå¤©'];
      if (irrelevantKeywords.some(kw => text.includes(kw))) {
        let guideMsg = 'é˜¿ç¦ç›®å‰å°ˆæ³¨æ–¼å”åŠ©æ‚¨æŠ•ä¿ï¼Œæˆ‘å€‘å¯ä»¥å…ˆå®ŒæˆæŠ•ä¿æµç¨‹å†ä¾†èŠèŠå…¶ä»–è©±é¡Œå–”ï¼';
        addMessage('bot', guideMsg);
        return;
      }

      if (step === 'DESTINATION') {
        handleDestination(text);
      } else if (step === 'DATES') {
        handleDateInput(text);
      }
    }, 600);
  };

  const handleQuickReply = (val, label) => {
    setInputText(label);
    setTimeout(() => {
        addMessage('user', label);
        if (step === 'DESTINATION') {
            setTimeout(() => handleDestination(label), 500);
        }
    }, 100);
    setInputText('');
  };

  const restart = () => {
    setMessages([{ id: generateId(), sender: 'bot', text: 'é‡æ–°é–‹å§‹å›‰ï¼è«‹å•æ‚¨é€™æ¬¡çš„æ—…éŠç›®çš„åœ°æ˜¯ï¼Ÿ' }]);
    setStep('DESTINATION');
    setTripData({ location: '', locationType: '', startTime: null, endTime: null, days: 0 });
    setQuotes([]);
    setDatePickerValues({ startDate: '', startTime: '08:00', endDate: '', endTime: '08:00' });
  };

  // --- Components ---

  const QuoteCard = ({ quote }) => {
    // Determine Badge Style
    let badgeStyle = "bg-[#4bbebe]/10 text-[#2a8585] border-[#4bbebe]/20"; // Default
    let badgeIcon = null;

    if (quote.badgeType === 'recommend') { // Cathay
        badgeStyle = "bg-orange-100 text-orange-700 border-orange-200 font-bold";
        badgeIcon = <Star className="w-3 h-3 fill-orange-500 text-orange-500 mr-1" />;
    } else if (quote.badgeType === 'sufficient') { // Fubon
        badgeStyle = "bg-blue-100 text-blue-700 border-blue-200 font-bold";
        badgeIcon = <Shield className="w-3 h-3 text-blue-600 mr-1" />;
    } else if (quote.badgeType === 'economic') { // Chubb
        badgeStyle = "bg-emerald-100 text-emerald-700 border-emerald-200 font-bold";
        badgeIcon = <TrendingDown className="w-3 h-3 text-emerald-600 mr-1" />;
    }

    return (
        <div className="min-w-[280px] md:min-w-[320px] bg-white rounded-xl shadow-lg border border-[#4bbebe]/20 p-5 flex flex-col snap-center mx-2 h-full relative overflow-hidden">
        
        {/* Top Badge (Absolute Positioned for consistency) */}
        {quote.badge && (
            <div className={`absolute top-0 right-0 px-3 py-1.5 text-xs rounded-bl-xl border-l border-b flex items-center shadow-sm ${badgeStyle}`}>
                {badgeIcon}
                {quote.badge}
            </div>
        )}

        <div className="flex justify-between items-start mb-4 mt-2">
            <div className="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">
            {quote.companyName}
            </div>
        </div>
        
        <h3 className="text-xl font-bold text-slate-800 mb-2 leading-tight">{quote.planName}</h3>
        <div className="text-sm text-slate-500 mb-4 pb-4 border-b border-slate-100">
            æ„å¤–èº«æ•…ä¿é¡: <span className="font-medium text-slate-800 text-lg ml-1">{(quote.sumInsured / 10000).toLocaleString()} è¬</span>
        </div>

        {/* Tags */}
        <div className="flex flex-wrap gap-2 mb-4">
            {quote.tags.slice(0, 3).map((tag, idx) => (
                <span key={idx} className="text-[11px] bg-[#4bbebe]/5 text-[#3aa8a8] px-2 py-1 rounded-md border border-[#4bbebe]/20">
                    {tag}
                </span>
            ))}
        </div>
        
        <div className="mt-auto">
            <div className="flex flex-col mb-3">
                <span className="text-xs text-slate-400 mb-1">é ä¼°ä¿è²»ç¯„åœ</span>
                <div className="text-2xl font-bold text-[#4bbebe]">
                    ${quote.range[0].toLocaleString()} ~ ${quote.range[1].toLocaleString()}
                </div>
            </div>
            <button className="w-full bg-[#4bbebe] hover:bg-[#3aa8a8] text-white py-3 rounded-lg text-sm font-bold transition-colors shadow-sm flex items-center justify-center gap-2">
            é¸æ“‡æ­¤æ–¹æ¡ˆ <ChevronRight className="w-4 h-4" />
            </button>
        </div>
        </div>
    );
  };

  return (
    <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-900 max-w-2xl mx-auto shadow-2xl overflow-hidden">
      
      {/* Header */}
      <header className="bg-[#4bbebe] p-4 flex items-center justify-between text-white shrink-0 shadow-md z-10">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/30">
             <span className="text-2xl">ğŸ•µï¸</span>
          </div>
          <div>
            <h1 className="font-bold text-lg tracking-wide">é˜¿ç¦ä¿éšªç®¡å®¶</h1>
            <p className="text-xs text-white/90">æŠ•ä¿æ—…å¹³éšªAIå°ˆæ¡ˆ</p>
          </div>
        </div>
        <button onClick={restart} className="p-2 hover:bg-white/10 rounded-full transition-colors text-white" title="é‡æ–°é–‹å§‹">
          <RefreshCw className="w-5 h-5" />
        </button>
      </header>

      {/* Chat Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 scroll-smooth">
        {messages.map((msg) => {
            // Render Card-Only Message
            if (msg.type === 'quote_cards') {
                return (
                    <div key={msg.id} className="w-full my-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="flex overflow-x-auto pb-6 pt-2 px-2 snap-x space-x-3 scrollbar-hide -mx-4 md:mx-0 pl-6 md:pl-2">
                            {msg.data.map((quote, idx) => (
                                <QuoteCard key={idx} quote={quote} />
                            ))}
                        </div>
                    </div>
                );
            }

            // Render Standard Text Bubble
            return (
                <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`flex gap-2 max-w-[85%] ${msg.sender === 'user' ? 'flex-row-reverse' : ''}`}>
                    
                    {/* Avatar */}
                    <div className={`w-9 h-9 rounded-full flex-shrink-0 flex items-center justify-center text-sm shadow-sm
                        ${msg.sender === 'user' 
                        ? 'bg-slate-200 text-slate-600' 
                        : 'bg-[#4bbebe] text-white border-2 border-white'}`}>
                        {msg.sender === 'user' ? <User className="w-5 h-5" /> : 'ğŸ•µï¸'}
                    </div>

                    {/* Message Bubble */}
                    <div className={`rounded-2xl p-3.5 shadow-sm text-sm leading-relaxed whitespace-pre-wrap relative
                        ${msg.sender === 'user' 
                        ? 'bg-[#4bbebe] text-white rounded-tr-none' 
                        : 'bg-white text-slate-700 border border-slate-100 rounded-tl-none'}`}>
                        
                        {msg.type === 'loading' ? (
                        <div className="flex gap-1 items-center h-5 px-2">
                            <span className="w-1.5 h-1.5 bg-[#4bbebe] rounded-full animate-bounce"></span>
                            <span className="w-1.5 h-1.5 bg-[#4bbebe] rounded-full animate-bounce delay-100"></span>
                            <span className="w-1.5 h-1.5 bg-[#4bbebe] rounded-full animate-bounce delay-200"></span>
                        </div>
                        ) : (
                        msg.text
                        )}
                    </div>
                    </div>
                </div>
            );
        })}
        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <div className="bg-white border-t border-slate-200 p-3 shrink-0 pb-6 z-10">
        
        {step === 'DESTINATION' && (
          <div className="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide">
            {HOT_SPOTS.map((spot, idx) => (
              <button 
                key={idx}
                onClick={() => handleQuickReply(spot.value, spot.label)}
                className="whitespace-nowrap px-4 py-2 bg-[#4bbebe]/5 text-[#2a8585] rounded-full text-xs font-medium border border-[#4bbebe]/20 hover:bg-[#4bbebe]/10 transition-colors shadow-sm"
              >
                {spot.label}
              </button>
            ))}
          </div>
        )}

        {step === 'DATES' && (
            <div className="mb-3 p-3 bg-[#4bbebe]/5 rounded-xl border border-[#4bbebe]/20 shadow-inner">
                <div className="flex items-center gap-2 mb-2 text-xs font-bold text-[#2a8585]">
                    <Calendar className="w-3 h-3" /> æ—¥æœŸé¸æ“‡å™¨ (æˆ–æ–¼ä¸‹æ–¹ç›´æ¥è¼¸å…¥)
                </div>
                <div className="grid grid-cols-2 gap-3 mb-3">
                    <div className="flex flex-col gap-1">
                        <label className="text-[10px] text-slate-500 font-medium ml-1">å‡ºç™¼æ™‚é–“</label>
                        <div className="flex gap-1">
                            <input 
                                type="date" 
                                className="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-[#4bbebe] outline-none"
                                value={datePickerValues.startDate}
                                onChange={(e) => setDatePickerValues({...datePickerValues, startDate: e.target.value})}
                            />
                            <input 
                                type="time" 
                                className="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-[#4bbebe] outline-none"
                                value={datePickerValues.startTime}
                                onChange={(e) => setDatePickerValues({...datePickerValues, startTime: e.target.value})}
                            />
                        </div>
                    </div>
                    <div className="flex flex-col gap-1">
                        <label className="text-[10px] text-slate-500 font-medium ml-1">è¿”å›æ™‚é–“</label>
                        <div className="flex gap-1">
                            <input 
                                type="date" 
                                className="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-[#4bbebe] outline-none"
                                value={datePickerValues.endDate}
                                onChange={(e) => setDatePickerValues({...datePickerValues, endDate: e.target.value})}
                            />
                            <input 
                                type="time" 
                                className="w-full text-xs p-1.5 rounded border border-slate-300 focus:border-[#4bbebe] outline-none"
                                value={datePickerValues.endTime}
                                onChange={(e) => setDatePickerValues({...datePickerValues, endTime: e.target.value})}
                            />
                        </div>
                    </div>
                </div>
                <button 
                    onClick={submitDatesFromPicker}
                    className="w-full py-2 bg-[#4bbebe] hover:bg-[#3aa8a8] text-white rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1 shadow-sm"
                >
                    <CheckCircle className="w-4 h-4" /> ä½¿ç”¨é¸æ“‡å™¨çš„æ—¥æœŸ
                </button>
            </div>
        )}

        <div className="flex gap-2 items-center relative">
          <input
            type="text"
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleInput()}
            placeholder={
                step === 'DESTINATION' ? "è¼¸å…¥åœ‹å®¶æˆ–åŸå¸‚..." :
                step === 'DATES' ? "æ‰‹å‹•è¼¸å…¥ (ä¾‹ï¼šä¸‹é€±äº”å»æ—¥æœ¬äº”å¤©) æˆ–ç”¨ä¸Šæ–¹é¸æ“‡å™¨" :
                step === 'QUOTATION' ? "å ±åƒ¹å®Œæˆï¼Œè«‹é‡æ–°é–‹å§‹..." :
                "è«‹è¼¸å…¥è¨Šæ¯..."
            }
            disabled={step === 'QUOTATION' && quotes.length > 0}
            className="flex-1 bg-slate-100 border-none rounded-full px-4 py-3 focus:ring-2 focus:ring-[#4bbebe] focus:bg-white transition-all text-sm outline-none disabled:opacity-50 text-slate-700 placeholder:text-slate-400"
          />
          <button 
            onClick={handleInput}
            disabled={!inputText.trim() || (step === 'QUOTATION' && quotes.length > 0)}
            className="w-10 h-10 bg-[#4bbebe] hover:bg-[#3aa8a8] text-white rounded-full flex items-center justify-center transition-transform active:scale-95 disabled:bg-slate-300 disabled:cursor-not-allowed shadow-md"
          >
            <Send className="w-5 h-5 ml-0.5" />
          </button>
        </div>
        
        {step === 'QUOTATION' && (
            <div className="text-center mt-2 text-xs text-slate-400">
                AI ç¬¬ä¸€éšæ®µå ±åƒ¹å®Œæˆã€‚
            </div>
        )}
      </div>
    </div>
  );
};

export default App;
